@model DebitNoteChooseInvoiceViewModel
@using SSMO.Services.Products
@using SSMO.Services.MyCompany
@using SSMO.Services.CustomerOrderService
@inject IProductService service;
@inject IMycompanyService mycompanyService;
@inject ICustomerOrderService customerOrderService;

<form method="post">
    <div class="container">
        <div class="row col-md-4 mb-3">
            <label asp-for="MyCompanyId">Seller</label>
            <select name= "MyCompanyId" asp-for="MyCompanyId" class="form-control">
            <option value="">All</option>
                @foreach (var myCompany in Model.MyCompanies)
                {
                    <option value="@myCompany.Id">@myCompany.Name</option>
                }

            </select>
        </div>
         <div class="row col-md-4 mb-3">           
            <label class="control-label"> Select Invoice</label>
           <select class="form-control" id="InvoiceId" name="InvoiceId" asp-for="InvoiceId" asp-items="@(new SelectList(string.Empty,"InvoiceId", "InvoiceNumber"))"></select>               
        </div>    
        <div class="row col-md-4" id="datepicker">
        <label asp-for="Date" >Date Debit note</label>
        <input itemid="date" asp-for="Date" name="Date" type="date" value="@DateTime.Now.ToString("dd-MM-yyyy")" class="form-control"/> 
        <span asp-validation-for="Date" class="small text-danger"></span>
        </div>       
         <div class="row col-md-4">   
         <label asp-for="DeliveryAddress"></label>
         <input id="deliveryAddress" class="form-control" type="text" asp-for="DeliveryAddress" name="DeliveryAddress">         
        </div>        
        <hr />
        <div class="table-responsive">
            <p>Available Products on stock</p>
       <table id="purchaseProductsTable" class="table table-bordered">
        <thead class="thead-light">
            <tr>
                <td>Check</td>
                <td>Description</td>                
                <td>FSC claim</td>
                <td>FSC certificate</td>
                <td>Unit</td>
                <td>Pallets</td>
                <td>Sheets/pallet</td>
                <td>Quantity</td>
                <td>Price</td>    
                <td>Customer Order No</td>
            </tr>
        </thead>
        <tbody>
                    @for (int i = 0; i < Model.PurchaseProducts.Count(); i++)
                    {
                    <div>
                           <input type="hidden" value="@Model.PurchaseProducts[i].Id" asp-for="@Model.PurchaseProducts[i].Id">
                     </div>
                    <div>
                           <input type="hidden" value="@Model.PurchaseProducts[i].ProductId" asp-for="@Model.PurchaseProducts[i].ProductId">
                    </div>                     

                    <tr>   
                        <td>
                            <input asp-for="@Model.PurchaseProducts[i].Checked" type="checkbox">
                        </td>
                            <td class="col-md-2">
                                    <div class="editor-field">
                                        <input asp-for="@Model.PurchaseProducts[i].ProductFullDescription" value="@Model.PurchaseProducts[i].ProductFullDescription" required="required">
                                        <span asp-validation-for="@Model.PurchaseProducts[i].ProductFullDescription" class="small text-danger"></span>
                                        </div>
                            </td>
                        <td class="col-sm-1">
                            <div class="editor-field">                              
                                      <input asp-for="@Model.PurchaseProducts[i].FscClaim" value="@Model.PurchaseProducts[i].FscClaim" required="required">
                                   <span asp-validation-for="@Model.PurchaseProducts[i].FscClaim" class="small text-danger"></span>
                          </div>
                        </td>

                        <td class="col-sm-1">
                            <div class="editor-field">
                                    <select asp-for="@Model.PurchaseProducts[i].FscSertificate" >
                                    <option value="-">-</option>
                                            <option value="@Model.PurchaseProducts[i].FscSertificate">@Model.PurchaseProducts[i].FscSertificate</option>
                                        <span asp-validation-for="@Model.PurchaseProducts[i].FscSertificate" class="small text-danger"></span>
                                </select>
                            </div>
                        </td>
                        <td class="col-sm-1">
                                <div class="editor-field">
                                    <input asp-for="@Model.PurchaseProducts[i].Unit" value="@Model.PurchaseProducts[i].Unit" required="required">
                                    <span asp-validation-for="@Model.PurchaseProducts[i].Unit" class="small text-danger"></span>
                                    </div>
                        </td>
                        <td class="col-sm-1">
                            <div class="editor-field">
                                      <input asp-for="@Model.PurchaseProducts[i].Pallets" type="number"  required="required">
                                      <span asp-validation-for="@Model.PurchaseProducts[i].Pallets" class="small text-danger"></span>
                                </div>
                        </td>
                        <td class="col-sm-1">
                            <div class="editor-field">
                                    <input asp-for="@Model.PurchaseProducts[i].SheetsPerPallet"  type="number" required="required">
                                     <span asp-validation-for="@Model.PurchaseProducts[i].SheetsPerPallet" class="small text-danger"></span>
                                    </div>
                        </td>
                            <td class="col-sm-1">
                            <div class="editor-field">
                                           <input asp-for="@Model.PurchaseProducts[i].DebitNoteQuantity"  required="required">
                                           <span asp-validation-for="@Model.PurchaseProducts[i].DebitNoteQuantity" class="small text-danger"></span>
                                    </div>
                        </td>

                        <td class="col-sm-1">
                            <div class="editor-field">
                                 <input asp-for="@Model.PurchaseProducts[i].Price"  type="number" min="0.0000" step="0.0001" required="required">
                                  <span asp-validation-for="@Model.PurchaseProducts[i].Price" class="small text-danger"></span>
                            </div>
                        </td>   
                            <td class="col-sm-1">
                                @if(Model.PurchaseProducts[i].CustomerOrderDetail == null)
                                {
                                    <p>-</p>
                                }
                                else
                                {
                                    <div class="form-group">
                                    <label>Customer Order</label>
                                      <select  asp-for="@Model.PurchaseProducts[i].ChoosenCustomerOrderProductDetailsId" class="form-select">
                                      <option value="">-</option>
                                     @foreach (var purchaseProduct in Model.PurchaseProducts[i].CustomerOrderDetail)
                                       {
                                        <option value="@purchaseProduct.CustomerOrderProductId">@purchaseProduct.OrderConfirmationNumber</option>
                                        <br />
                                       }  
                                    </select>
                                </div>
                                }
                            </td>   
                    </tr>
                    }
        </tbody>
    </table>
        </div>
         <div class="row col-md-4">         
         <input id="moreQuantity" class="form-check-input" type="checkbox" asp-for="MoreQuantity" name="moreQuantity">
         <label asp-for="MoreQuantity">Update Quantity on Existing Product from the Invoice:</label>
        </div>
        <div class="table-responsive-sm">
            <table id="productTable" class="table-striped">
                <thead>
                    <tr>                       
                        <th>Description</th>
                        <th>Size</th>
                        <th>Grade</th>          
                        <th>FSC Claim</th>
                        <th>FSC Certificate</th>
                        <th>Unit</th>
                        <th>Unit Price</th>   
                        <th class="center">Quantity</th>                        
                    </tr>
                </thead>
               <tbody >             
                    @for (int i = 0; i < Model.Products.Count(); i++)
                    {
                                <tr id="tablerow0">                           
                                    <td>
                                        <div class="editor-field">
                                            <select name="DescriptionId[0]" asp-for="Products.ElementAt(i).DescriptionId" class="text-box single-line">
                                            <option value="0">All</option>
                                        @foreach (var description in Model.Products.ElementAt(i).Descriptions)
                                        {
                                            <option value="@description.Id">@description.Name</option>
                                        }
                                            </select>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="editor-field">
                                                    <select name="SizeId[0]" asp-for="Products.ElementAt(i).SizeId" class="text-box single-line">
                                            <option value="">All</option>
                                        @foreach (var size in Model.Products.ElementAt(i).Sizes)
                                        {
                                              <option value="@size">@size</option>
                                        }
                                            </select>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="editor-field">
                                             <select name="GradeId[0]" asp-for="Products.ElementAt(i).GradeId" class="text-box single-line">
                                             <option value="">All</option>
                                        @foreach (var grade in Model.Products.ElementAt(i).Grades)
                                        {
                                               <option value="@grade">@grade</option>
                                        }
                                            </select>
                                        </div>
                                    </td>                           
                                     <td>
                                        <div class="editor-field">
                                            <input asp-for="Products.ElementAt(i).FscClaim" class="text-box single-line" name="FscClaim[0]" value="" required="required">
                                        </div>
                                    </td>
                                    <td>
                                        <div class="editor-field">
                                            <select name="FscCertificate[0]" asp-for="Products.ElementAt(i).FscSertificate" class="text-box single-line">
                                            <option value="">-</option>
                                        @foreach (var fsc in mycompanyService.MyCompaniesFscList())
                                        {
                                             <option value="@fsc">@fsc</option>
                                        }
                                                </select>
                                        </div>
                                    </td>
                                         <td class="col-sm-1">
                                                <div class="editor-field">
                                                <select name="Unit" asp-for="Products.ElementAt(i).Unit" class="text-box single-line">
                                        @foreach (var unit in service.GetUnits())
                                        {
                                            <option value="@unit">@unit</option>
                                        }
                                                    </select>
                                            </div>
                                        </td>
                                    <td>
                                        <div class="editor-field">
                                            <input asp-for="Products.ElementAt(i).Price" class="text-box single-line" name="Price[0]" value="" required="required">
                                        </div>
                                    </td>                                    
                                    <td>
                                        <div class="editor-field">
                                            <input asp-for="Products.ElementAt(i).Quantity" class="text-box single-line" name="Quantity[0]" value="" required="required">
                                        </div>
                                    </td>                            
                                    <td>
                                        <button type="button" class="btn-danger" onclick="removeTr(0);">Delete</button>
                                    </td>
                               </tr>
                                <tr>

                                </tr>
                    }                  
                  </tbody>                
            </table>
            <div class="row p-3">
                <button id="addrow" type="button" class="btn btn-outline-success">Add</button>
            </div>
        </div> 
   <input type="submit" class="btn-primary" value="Submit"/>      
    </div>
</form>

@section Scripts {

            <script type="text/javascript">
                $(function () {
                    $("#datepicker").datepicker();
                });
                </script>
                <script>
                    $function(){
                            $("#moreQuantity").onclick(function(){
                                    $("#purchaseProductsTable").load()
                            }
                            )
                    }
                </script>

                 <script type="text/javascript">
                    $(document).ready(function() {                       
                        $("#MyCompanyId").change(function() {                        
                            $("#InvoiceId option").remove();
                            var myCompanyId = $(this).val(); 
                            $.ajax({
                                type: 'GET',
                                url: "/Documents/GetInvoiceNumbers", // we are calling json method
                                dataType: 'json',
                                data: { id: myCompanyId },
                                success: function(selectedInvoiceNumbers) {
                                    // customers contains the JSON formatted list
                                    // of invoices passed from the controller

                                    $("#InvoiceId").append('<option value="' + "0" + '">' + "Select InvoiceNumber" + '</option>');
                                    debugger;
                                    for (var i = 0; i < selectedInvoiceNumbers.length; i++) 
                                    {
                                       $("#InvoiceId").append('<option value="' + selectedInvoiceNumbers[i].InvoiceId + '">' + selectedInvoiceNumbers[i].InvoiceNumber + '</option>');
                                    }       

                                    debugger;
                                    //var numbers = '';
                                    //$(#InvoiceNumber).empty();
                                        //$.each(selectedInvoiceNumbers, function(i, invoice) {
                                                    //    numbers += '<option value="' + invoice.InvoiceId + '">' + invoice.InvoiceNumber + '</option>';
                                    //    // here we are adding option for Supplier
                                        //}); $(#InvoiceNumber).html(invoice);
                               },
                                error: function(ex) {
                                    alert('Failed to retrieve invoiceId' + ex);
                                }
                            });
                            return false;
                        });
                    });

                        var counter = 1;
                        $(function products () {
                                $('#addrow').click(function () {
                                $('<tr id="tablerow' + counter + '"><td>' +
                                             ' <select class="text-box single-line" name="DescriptionId[' + counter + ']" asp-for="DescriptionId" ><option value="">All</option>@foreach (var desc in service.DescriptionIdAndNameList()){<option value="@desc.Id">@desc.Name</option>}</select>' +
                                    '</td>' +
                                    '<td>' +
                                        '<select class="text-box single-line" name="SizeId[' + counter + ']" asp-for="SizeId" ><option value="">All</option>@foreach (var size in service.SizeIdAndNameList()){<option value="@size.Id">@size.Name</option>}</select>' +
                                    '</td>' +
                                    '<td>' +
                                        '<select class="text-box single-line" name="GradeId[' + counter + ']" asp-for="GradeId" ><option value="">All</option>@foreach (var grade in service.GradeIdAndNameList()){<option value="@grade.Id">@grade.Name</option>}</select>' +
                                    '</td>' + 
                                    '<td>' +
                                    '<input class="text-box single-line" name="FscClaim[' + counter + ']" value="" required="required" />' +
                                    '</td>' +
                                    '<td>' +
                                    '<select class="text-box single-line" name ="FscSertificate[' + counter +']" asp-for = "FscSertificate"><option value="">-</option> @foreach (var fsc in mycompanyService.MyCompaniesFscList()){<option value="@fsc">@fsc</option>}</select>' +
                                    '</td>'+
                                    '<td>' +
                                            '<select class="text-box single-line" name ="Unit[' + counter +']" asp-for = "Unit"><option value="">All</option> @foreach (var unit in service.GetUnits()){<option value="@unit">@unit</option>}</select>' +
                                    '</td>'+                              

                                    '<td>' +
                                    '<input class="text-box single-line" name="Price[' + counter + ']" value="" required="required" />' +
                                    '</td>' +                                    
                                    '<td>' +
                                    '<input class="text-box single-line" name="Quantity[' + counter + ']" value="" required="required" />' +
                                    '</td>' +
                                    '<td>' +
                                     '<button type="button" class="btn btn-primary" onclick="removeTr(' + counter + ');">Delete</button>' +
                                    '</td>' +                                        
                                  '</tr>').appendTo('#productTable');
                                counter++;
                                return false;
                            });
                        });

                        function removeTr(index) {
                            if (counter > 1) {
                                $('#tablerow' + index).remove();
                                counter--;
                            }
                            return false;
                        }
                  </script>
                    @*  <script type="text/javascript">
        $(function onchange(){
                             $("#InvoiceId").change(function()
                                { 
                                    var invoiceId = $(this).find('option:selected').val();  
                                if(invoiceId != 0 {
                                         $.ajax({
                                                type:'GET',
                                                url: "/Documents/GetProductsForDebitNote",
                                                dataType : 'json',
                                                data: {id = invoiceId},
                                                success: function(products)
                                                    {
                                                        var table = $('#productTable');
                                                        $(table).find("tr:gt(0)").remove();                                                
                                                        var row="";
                                                        for(var i=0; i< products.length;i++)
                                                            {
                                                                row += "<tr><td>" + ' <select class="text-box single-line" name="DescriptionId[' + i + ']" asp-for="DescriptionId" ><option value="">All</option>@foreach (var desc in service.DescriptionIdAndNameList()) { <option value="@desc.Id">@desc.Name</option>}</select>' + "</td><td>" + products[i].Grade + "</td><td>" + products[i].Size + "</td><td>" + products[i].Unit + "</td><td>" + products[i].Quantity + "</td><td>" + products[i].Price + "</td></tr>");
                                                            }
                                                        table.append(rows);    
                                                        },
                                        });
                                }
                                    debugger
                                   // return false;
                             });
                    });
                  </script>*@
    }

                    